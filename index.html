<!DOCTYPE html>
<html>
<head>
  <title>Free Route & Mileage</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 500px; margin-top: 20px; }
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input, button { padding: 8px; margin-top: 5px; width: 100%; }
    button { background: black; color: white; border: none; cursor: pointer; }
    #distance, #routeStates, #endMiles { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Route & Mileage (OpenRouteService)</h2>
  <form id="routeForm">
    <label>Start (City, ST):</label>
    <input type="text" id="start" value="Catoosa, OK" required>
    <label>End (City, ST):</label>
    <input type="text" id="end" value="Bowie, TX" required>
    <label>Current Miles:</label>
    <input type="number" id="currentMiles" placeholder="e.g. 127890" required>
    <button type="submit">Get Route</button>
  </form>

  <p id="distance"></p>
  <p id="endMiles"></p>
  <p id="routeStates"></p>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const proxyUrl = "https://bdab58c3-c7ac-4bf6-aefe-63e42a0f075c-00-b6qrx55zbg65.picard.replit.dev";

    const stateAbbreviations = {
      "Alabama": "AL", "Alaska": "AK", "Arizona": "AZ", "Arkansas": "AR", "California": "CA",
      "Colorado": "CO", "Connecticut": "CT", "Delaware": "DE", "Florida": "FL", "Georgia": "GA",
      "Hawaii": "HI", "Idaho": "ID", "Illinois": "IL", "Indiana": "IN", "Iowa": "IA", "Kansas": "KS",
      "Kentucky": "KY", "Louisiana": "LA", "Maine": "ME", "Maryland": "MD", "Massachusetts": "MA",
      "Michigan": "MI", "Minnesota": "MN", "Mississippi": "MS", "Missouri": "MO", "Montana": "MT",
      "Nebraska": "NE", "Nevada": "NV", "New Hampshire": "NH", "New Jersey": "NJ", "New Mexico": "NM",
      "New York": "NY", "North Carolina": "NC", "North Dakota": "ND", "Ohio": "OH", "Oklahoma": "OK",
      "Oregon": "OR", "Pennsylvania": "PA", "Rhode Island": "RI", "South Carolina": "SC",
      "South Dakota": "SD", "Tennessee": "TN", "Texas": "TX", "Utah": "UT", "Vermont": "VT",
      "Virginia": "VA", "Washington": "WA", "West Virginia": "WV", "Wisconsin": "WI", "Wyoming": "WY"
    };

    const map = L.map('map').setView([39, -98], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    let routeLayer;

    async function geocodeNominatim(place) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.length) throw new Error(`Location not found: ${place}`);
      return [parseFloat(data[0].lon), parseFloat(data[0].lat)];
    }

    async function getStateFromCoords(lat, lon) {
      const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`;
      const res = await fetch(url);
      const data = await res.json();
      const stateName = data.address?.state;
      return stateAbbreviations[stateName] || null;
    }

    document.getElementById("routeForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      const currentMiles = parseFloat(document.getElementById("currentMiles").value);

      if (isNaN(currentM
